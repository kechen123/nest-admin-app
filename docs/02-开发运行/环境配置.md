# 环境配置

> 📖 **文档导航**：[返回首页](../../README.md) | [快速开始](./快速开始.md) | [开发环境](./开发环境.md)  
> 👋 **如果你是第一次使用这个项目，完全不懂编程，请直接跳到"🎓 第一次使用完整流程"部分。**

本文档提供从零开始初始化项目的完整步骤。

## 📋 前置要求

- Node.js >= 18.0.0
- Docker >= 20.10.0
- Docker Compose >= 2.0.0

## 📦 前置条件安装指南

### 1. 安装 Node.js

**什么是 Node.js？**
Node.js 是一个运行 JavaScript 的环境，我们的项目需要它来运行。

**如何安装？**
1. 访问 https://nodejs.org/
2. 下载 LTS 版本（推荐，更稳定）
3. 双击安装包，一路点击"下一步"完成安装
4. **重要**：安装时确保勾选"添加到 PATH"选项

**如何检查是否安装成功？**
打开命令行（Windows: 按 Win+R，输入 `cmd`，回车；Mac: 按 Cmd+Space，输入 `terminal`，回车；Linux: 按 Ctrl+Alt+T），输入：
```bash
node --version
```
应该显示类似 `v18.0.0` 的版本号。如果显示"不是内部或外部命令"或"command not found"，说明没有安装成功。

**如何检查 npm？**
npm 是 Node.js 自带的包管理工具，输入：
```bash
npm --version
```
应该显示版本号，如 `9.0.0`。

**如果命令找不到怎么办？**
1. 确认 Node.js 已安装
2. **关闭并重新打开命令行窗口**（这很重要！）
3. 如果还是不行，重新安装 Node.js，确保勾选"添加到 PATH"

### 2. 安装 Docker

**什么是 Docker？**
Docker 是一个容器化平台，可以让你轻松运行应用程序，不需要手动配置环境。

**如何安装？**
- **Windows/Mac**: 访问 https://www.docker.com/products/docker-desktop/ 下载 Docker Desktop
- **Linux (Ubuntu/Debian)**: 
  ```bash
  sudo apt update
  sudo apt install docker.io docker-compose
  sudo systemctl start docker
  sudo systemctl enable docker
  ```

**如何检查是否安装成功？**
```bash
docker --version
```
应该显示版本号，如 `Docker version 20.10.0`。

**如何启动 Docker？**
- **Windows/Mac**: 双击桌面上的 Docker Desktop 图标，等待启动完成
- **Linux**: Docker 服务通常会自动启动，如果没有，运行 `sudo systemctl start docker`

**如何检查 Docker 是否运行？**
```bash
docker ps
```
如果显示容器列表（可能是空的，显示 "CONTAINER ID" 等表头），说明 Docker 正在运行。如果显示错误信息，说明 Docker 没有启动。

**Docker 启动失败的常见原因：**
- Windows: 需要启用 WSL 2 或 Hyper-V
- Mac: 需要给 Docker Desktop 足够的系统权限
- Linux: 需要将用户添加到 docker 组：`sudo usermod -aG docker $USER`，然后重新登录

### 3. 验证所有前置条件

运行以下命令，确认所有工具都已安装：

```bash
node --version    # 应该显示 v18.0.0 或更高版本
npm --version     # 应该显示版本号
docker --version  # 应该显示 Docker version 20.10.0 或更高版本
docker ps         # 应该显示容器列表（可能是空的）
```

如果所有命令都能正常显示版本号，说明准备工作完成！✅

## 🎓 第一次使用完整流程（零基础版）

如果你是第一次使用这个项目，完全不懂编程，请按照以下步骤操作：

### 准备工作（只需做一次）

1. **安装必要软件**
   - [ ] 安装 Node.js（见上面的"前置条件安装指南"）
   - [ ] 安装 Docker Desktop（见上面的"前置条件安装指南"）
   - [ ] （可选）安装 VS Code 编辑器：https://code.visualstudio.com/

2. **验证安装**
   ```bash
   node --version    # 应该显示版本号
   npm --version     # 应该显示版本号
   docker --version  # 应该显示版本号
   ```

3. **启动 Docker**
   - 双击桌面上的 Docker Desktop 图标
   - 等待启动完成（系统托盘图标不再闪烁，Windows 右下角或 Mac 右上角）

### 第一次运行项目

**步骤 1：打开命令行**
- **Windows**: 按 Win+R，输入 `cmd`，回车
- **Mac**: 按 Cmd+Space，输入 `terminal`，回车
- **Linux**: 按 Ctrl+Alt+T

**步骤 2：进入项目文件夹**
```bash
# Windows 示例（假设项目在 D:\code\me\yl）
cd D:\code\me\yl

# Mac/Linux 示例（假设在 ~/code/yl）
cd ~/code/yl
```

**如何确认位置正确？**
运行以下命令：
- **Windows**: `dir`，应该能看到 `package.json` 文件
- **Mac/Linux**: `ls`，应该能看到 `package.json` 文件

如果看不到 `package.json`，说明位置不对，需要重新进入正确的文件夹。

**步骤 3：检查环境变量文件**
```bash
# Windows
dir backend\.env

# Mac/Linux
ls backend/.env
```

如果显示"找不到文件"或"No such file"，需要创建 `.env` 文件（见下面的"配置环境变量"部分）。

**步骤 4：启动服务（Docker 模式）**
```bash
npm run dev:up
```

**等待 30-60 秒**，这个过程中会：
- 下载 Docker 镜像（第一次需要，可能较慢）
- 启动 MySQL 数据库
- 启动后端服务
- 启动前端服务

**如何判断启动成功？**
运行：
```bash
npm run ps
```

应该看到三个容器都在运行：
- `yl-mysql-dev` - MySQL 数据库
- `yl-backend-dev` - 后端服务
- `yl-web-dev` - 前端服务

如果看到 "Up" 或 "healthy" 状态，说明启动成功！

**步骤 5：初始化数据库**
```bash
npm run backend:init-db
```

**成功的标志：** 看到 "数据库初始化完成！" 和 "✅ 数据库 xxx 创建成功"

**如果失败怎么办？**
- 等待更长时间（MySQL 可能需要 30-60 秒才能完全启动）
- 查看日志：`npm run mysql:logs`
- 查看本文档的"常见错误"部分

**步骤 6：访问应用**
打开浏览器（Chrome、Firefox、Edge 都可以），访问：
- **前端应用**: http://localhost:4000 （应该能看到登录页面）
- **后端 API**: http://localhost:3000/api （应该能看到 Swagger 文档页面）

**如果打不开怎么办？**
- 确认服务已启动：`npm run ps`
- 检查服务健康状态：`npm run health`
- 查看日志：`npm run dev:logs`

**步骤 7：登录测试**
在登录页面输入：
- **用户名**：`admin`
- **密码**：`admin123`

点击登录，如果能看到系统主页面，说明一切正常！🎉

**恭喜你！** 项目已经成功运行了！

## 🧹 清理现有环境（如果需要）

如果之前已经运行过项目，需要清理：

```bash
# 停止并删除所有容器和数据卷（⚠️ 会删除所有数据库数据）
npm run reset

# 或手动清理
npm run dev:down
docker volume rm yl_mysql_data
```

**重要提示**：如果修改了 `backend/.env` 中的 `DB_PASSWORD`，必须删除 MySQL 数据卷并重新初始化，因为 MySQL 容器的 root 密码是在首次启动时设置的。

## 🚀 完整初始化步骤

### 1. 检查/编辑环境变量（如需要）

环境变量文件已内置在项目中，如需修改配置，请编辑以下文件：

**后端配置** (`backend/.env`)：
```env
# 数据库配置（Docker 环境会自动覆盖 DB_HOST）
DB_HOST=localhost          # Docker 运行时会被覆盖为 mysql
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=root          # 请修改为安全密码
DB_DATABASE=myapp_db

# 应用配置
NODE_ENV=development
PORT=3000
JWT_SECRET=dev-secret-key  # 请修改为随机字符串
CORS_ORIGIN=http://localhost:4000
```

**前端配置** (`web/.env.development`)：
```env
# API 基础路径（开发环境使用代理，无需配置）
# VITE_APP_BASE_API=/api
```

### 2. 启动 Docker 服务

```bash
# 启动所有服务（后台运行）
npm run dev:up

# 查看服务状态
npm run ps
```

等待所有服务启动完成（约 30-60 秒），特别是 MySQL 需要时间初始化。

### 3. 初始化数据库

```bash
# 等待 MySQL 完全启动后（约 20-30 秒），执行数据库初始化
npm run backend:init-db
```

**重要提示**：
- 如果修改了 `backend/.env` 中的 `DB_PASSWORD`，必须先删除 MySQL 数据卷并重新启动容器
- MySQL 容器的 root 密码是在首次启动时设置的，后续修改 `.env` 文件不会自动更新密码
- 如果遇到密码验证失败，请执行 `npm run reset` 清理后重新初始化

**预期输出：**
```
正在初始化数据库 myapp_db...
检测到 Docker 环境，使用 MySQL 服务: mysql:3306
数据库初始化完成！

数据库信息:
  数据库名: myapp_db
  默认管理员账号: admin
  默认管理员密码: admin123

⚠️  请在生产环境中修改默认密码！
```

### 4. 验证服务

#### 检查容器状态

```bash
npm run ps
```

应该看到三个容器都在运行：
- `yl-mysql-dev` - MySQL 数据库（状态：healthy）
- `yl-backend-dev` - 后端服务（状态：Up）
- `yl-web-dev` - 前端服务（状态：Up）

#### 访问服务

- **前端应用**: http://localhost:4000
- **后端 API**: http://localhost:3000/api
- **Swagger 文档**: http://localhost:3000/api

#### 测试 MySQL 连接（Navicat 等工具）

- **主机**: `localhost` 或 `127.0.0.1`
- **端口**: `3306`
- **用户名**: `root`
- **密码**: `root`（或 `.env` 中配置的 `DB_PASSWORD`）
- **数据库**: `myapp_db`

**注意**：数据库初始化脚本会自动配置外部连接权限，无需额外操作。如果遇到连接问题，可以重新运行初始化脚本。

## 🆘 常见错误及解决方案

### 错误 1: "npm 不是内部或外部命令" 或 "command not found: npm"

**原因：** Node.js 没有安装或没有添加到系统路径

**解决方案：**
1. 重新安装 Node.js（从 https://nodejs.org/ 下载）
2. 安装时确保勾选"添加到 PATH"选项
3. 安装完成后，**关闭并重新打开命令行窗口**（这很重要！）
4. 再次尝试运行命令

### 错误 2: "docker 不是内部或外部命令" 或 "command not found: docker"

**原因：** Docker 没有安装或没有启动

**解决方案：**
1. 确认已安装 Docker Desktop
2. 双击桌面上的 Docker Desktop 图标启动
3. 等待 Docker 启动完成（系统托盘图标不再闪烁）
4. 重新运行命令

### 错误 3: "端口 3306 已被占用" 或 "Port 3306 is already in use"

**原因：** 你的电脑上已经有其他程序在使用 3306 端口（可能是另一个 MySQL）

**解决方案：**

**方案 1：停止占用端口的程序（推荐）**
- **Windows**: 
  1. 打开任务管理器（Ctrl+Shift+Esc）
  2. 找到 MySQL 相关进程（如 mysqld.exe）
  3. 右键点击 → 结束任务
- **Mac/Linux**: 
  ```bash
  # 查看占用端口的程序
  sudo lsof -i :3306
  # 停止程序（替换 PID 为实际的进程号）
  sudo kill -9 <PID>
  ```

**方案 2：修改端口（不推荐，需要修改配置）**
编辑 `docker-compose.dev.yml`，将 `3306:3306` 改为 `3307:3306`（或其他未被占用的端口）

### 错误 4: "权限不足" 或 "Access Denied" 或 "Permission denied"

**原因：** 需要管理员权限

**解决方案：**
- **Windows**: 右键点击命令行图标 → 选择"以管理员身份运行"
- **Mac/Linux**: 在命令前加上 `sudo`（如 `sudo npm run mysql:start`）

### 错误 5: "找不到 backend/.env 文件" 或 "No such file or directory"

**原因：** 文件不存在或路径不对

**解决方案：**
1. 确认你在项目根目录（能看到 `package.json` 文件）
2. 确认 `backend` 文件夹存在
3. 如果文件不存在，需要创建：
   - 在 `backend` 文件夹中新建一个文本文件
   - 重命名为 `.env`（注意前面有个点）
   - 复制以下内容进去：
     ```env
     DB_HOST=localhost
     DB_PORT=3306
     DB_USERNAME=root
     DB_PASSWORD=root
     DB_DATABASE=myapp_db
     NODE_ENV=development
     PORT=3000
     JWT_SECRET=dev-secret-key
     CORS_ORIGIN=http://localhost:4000
     ```

### 错误 6: 命令执行后没有任何反应

**可能的原因和解决方案：**

1. **命令还在执行中**：某些命令需要等待，比如启动 MySQL 需要 10-20 秒，启动所有服务需要 30-60 秒
   - **解决方法**：等待一段时间，然后运行 `npm run ps` 检查状态

2. **命令执行成功但没有输出**：这是正常的，没有错误就是成功
   - **解决方法**：运行 `npm run ps` 或 `npm run health` 确认服务已启动

3. **命令卡住了**：按 Ctrl+C 停止，然后检查日志
   - **解决方法**：运行 `npm run mysql:logs` 查看 MySQL 日志，或 `npm run dev:logs` 查看所有日志

### 错误 7: "Cannot connect to database" 或数据库连接失败

**原因：** 无法连接到 MySQL 数据库

**检查步骤：**
1. 确认 MySQL 容器已启动：`npm run ps`
2. 确认 MySQL 容器状态为 "healthy" 或 "Up"
3. 检查 `.env` 文件中的数据库配置

**解决方案：**
```bash
# 重启 MySQL 容器
npm run mysql:stop
npm run mysql:start

# 等待 20-30 秒后，再次尝试
```

### 错误 8: "数据库认证失败" 或密码不一致

**原因：** MySQL 容器的密码与 `.env` 文件中的 `DB_PASSWORD` 不一致

**解决方案：**

**方案 1：删除数据卷并重新初始化（推荐）**
```bash
npm run mysql:stop
docker volume rm yl_mysql_data
npm run mysql:start
# 等待 MySQL 启动后
npm run backend:init-db
```

**方案 2：修改 .env 文件使用当前密码**
编辑 `backend/.env`，将 `DB_PASSWORD` 改为 MySQL 容器的实际密码（通常是 `root`）

## 📚 相关文档

- [快速开始](./快速开始.md)
- [开发环境](./开发环境.md)
- [本地运行](./本地运行.md)
- [数据库管理](./数据库管理.md)

