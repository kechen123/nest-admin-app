# 构建指南

> 📖 **文档导航**：[返回首页](../../README.md) | [部署指南](./部署指南.md) | [镜像导出](./镜像导出.md)

## 生产环境构建

### 多阶段构建

生产环境使用多阶段构建，优化镜像体积：

1. **构建阶段**: 安装依赖并构建应用
2. **运行阶段**: 只复制构建产物和运行时依赖

### 构建命令

```bash
# 构建所有服务
npm run build

# 或单独构建
docker-compose -f docker-compose.prod.yml build backend
docker-compose -f docker-compose.prod.yml build web
```

### 构建过程

构建过程可能需要 5-15 分钟，请耐心等待。

**构建的镜像包括**：
- `yl-project_backend:latest` - 后端服务镜像
- `yl-project_web:latest` - 前端服务镜像

### 验证镜像构建成功

```bash
# 查看所有镜像
docker images

# 查看镜像详细信息
docker inspect yl-project_backend:latest
docker inspect yl-project_web:latest
```

## 构建前准备

### 1. 检查环境

确保已安装 Docker Desktop（Windows/Mac）或 Docker Engine（Linux）：

```bash
docker --version
docker-compose --version
```

### 2. 配置生产环境变量

编辑 `backend/.env`，确保以下配置正确：

```env
DB_HOST=mysql
DB_PASSWORD=你的生产环境密码（必须修改）
JWT_SECRET=你的JWT密钥（必须修改，建议使用强密码）
NODE_ENV=production
CORS_ORIGIN=你的域名或IP地址
```

### 3. 构建镜像

```bash
# 在项目根目录执行
npm run build

# 构建完成后，查看镜像
docker images | grep yl
```

## 构建优化

### 清理构建缓存

如果构建出现问题，可以清理缓存后重新构建：

```bash
# 清理 Docker 缓存
docker system prune -a

# 重新构建（不使用缓存）
docker-compose -f docker-compose.prod.yml build --no-cache
```

### 检查磁盘空间

构建镜像需要足够的磁盘空间，建议至少 10GB 可用空间：

```bash
# Windows PowerShell
Get-PSDrive C | Select-Object Used,Free

# Linux/Mac
df -h
```

## 常见问题

### 问题 1：镜像构建失败

**症状**：`npm run build` 报错

**解决方案**：
```bash
# 清理 Docker 缓存
docker system prune -a

# 重新构建（不使用缓存）
docker-compose -f docker-compose.prod.yml build --no-cache

# 检查磁盘空间
df -h
```

### 问题 2：构建时间过长

**可能原因**：
- 网络速度慢（下载依赖）
- 磁盘 I/O 慢
- 系统资源不足

**解决方案**：
- 使用国内镜像源
- 增加 Docker 资源分配
- 在性能更好的机器上构建

## 📚 相关文档

- [部署指南](./部署指南.md) - 服务器部署流程
- [镜像导出](./镜像导出.md) - 镜像导出方法
- [生产环境配置](./生产环境配置.md) - 生产环境优化

