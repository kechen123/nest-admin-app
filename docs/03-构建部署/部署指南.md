# éƒ¨ç½²æŒ‡å—

> ğŸ“– **æ–‡æ¡£å¯¼èˆª**ï¼š[è¿”å›é¦–é¡µ](../../README.md) | [æ„å»ºæŒ‡å—](./æ„å»ºæŒ‡å—.md) | [é•œåƒå¯¼å‡º](./é•œåƒå¯¼å‡º.md) | [æ•…éšœæ’æŸ¥](./æ•…éšœæ’æŸ¥.md)

## ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡æœåŠ¡å™¨ç¯å¢ƒ

### 1.1 å®‰è£… Docker å’Œ Docker Compose

**Ubuntu/Debian**ï¼š

```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt-get update

# å®‰è£… Docker
sudo apt-get install -y docker.io docker-compose

# å¯åŠ¨ Docker æœåŠ¡
sudo systemctl start docker
sudo systemctl enable docker

# éªŒè¯å®‰è£…
docker --version
docker-compose --version
```

**CentOS/RHEL**ï¼š

```bash
# å®‰è£… Docker
sudo yum install -y docker docker-compose

# å¯åŠ¨ Docker æœåŠ¡
sudo systemctl start docker
sudo systemctl enable docker

# éªŒè¯å®‰è£…
docker --version
docker-compose --version
```

### 1.2 é…ç½®é˜²ç«å¢™

```bash
# Ubuntu/Debian (ufw)
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw reload

# CentOS/RHEL (firewalld)
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp
sudo firewall-cmd --reload
```

## ç¬¬äºŒæ­¥ï¼šéƒ¨ç½²åˆ°æœåŠ¡å™¨

### æ–¹å¼ä¸€ï¼šä½¿ç”¨é•œåƒæ–‡ä»¶éƒ¨ç½²ï¼ˆç¦»çº¿éƒ¨ç½²ï¼‰

#### 2.1 ä¼ è¾“æ–‡ä»¶åˆ°æœåŠ¡å™¨

**ä½¿ç”¨ SCP**ï¼š

```bash
# åœ¨æœ¬åœ°æ‰§è¡Œï¼ˆWindows éœ€è¦ä½¿ç”¨ Git Bash æˆ– WSLï¼‰
scp ~/Desktop/yl-images.tar user@your-server-ip:/opt/app/

# ä¼ è¾“é¡¹ç›®é…ç½®æ–‡ä»¶
scp docker-compose.prod.yml user@your-server-ip:/opt/app/
scp -r docker/ user@your-server-ip:/opt/app/
scp backend/.env user@your-server-ip:/opt/app/backend/
```

**ä½¿ç”¨ WinSCPï¼ˆWindows å›¾å½¢ç•Œé¢å·¥å…·ï¼‰**ï¼š
1. ä¸‹è½½å®‰è£… WinSCP
2. è¿æ¥åˆ°æœåŠ¡å™¨
3. æ‹–æ‹½æ–‡ä»¶åˆ°æœåŠ¡å™¨ `/opt/app/` ç›®å½•

#### 2.2 åœ¨æœåŠ¡å™¨ä¸ŠåŠ è½½é•œåƒ

```bash
# SSH ç™»å½•æœåŠ¡å™¨
ssh user@your-server-ip

# åˆ›å»ºé¡¹ç›®ç›®å½•
sudo mkdir -p /opt/app
cd /opt/app

# åŠ è½½é•œåƒ
docker load -i yl-images.tar

# éªŒè¯é•œåƒåŠ è½½æˆåŠŸ
docker images
```

#### 2.3 é…ç½®ç¯å¢ƒå˜é‡

```bash
# åˆ›å»ºå¿…è¦çš„ç›®å½•
mkdir -p backend

# ç¼–è¾‘ç¯å¢ƒå˜é‡æ–‡ä»¶
vim backend/.env
```

é…ç½®ç¤ºä¾‹ï¼š
```env
DB_HOST=mysql
DB_PASSWORD=ä½ çš„ç”Ÿäº§ç¯å¢ƒå¯†ç 
JWT_SECRET=ä½ çš„JWTå¯†é’¥
NODE_ENV=production
CORS_ORIGIN=ä½ çš„åŸŸåæˆ–IP
```

#### 2.4 ä¿®æ”¹ docker-compose.prod.ymlï¼ˆå¦‚æœä½¿ç”¨å¯¼å‡ºçš„é•œåƒï¼‰

å¦‚æœä½¿ç”¨å¯¼å‡ºçš„é•œåƒï¼Œéœ€è¦ä¿®æ”¹ `docker-compose.prod.yml`ï¼Œå°† `build` æ”¹ä¸º `image`ï¼š

```yaml
backend:
  image: yl-project_backend:latest  # æ”¹ä¸ºä½¿ç”¨é•œåƒè€Œä¸æ˜¯æ„å»º
  # build:  # æ³¨é‡Šæ‰ build éƒ¨åˆ†
  #   context: ./backend
  #   dockerfile: ../docker/backend/Dockerfile.prod

web:
  image: yl-project_web:latest  # æ”¹ä¸ºä½¿ç”¨é•œåƒè€Œä¸æ˜¯æ„å»º
  # build:  # æ³¨é‡Šæ‰ build éƒ¨åˆ†
  #   context: .
  #   dockerfile: ./docker/web/Dockerfile.prod
```

### æ–¹å¼äºŒï¼šåœ¨æœåŠ¡å™¨ä¸Šç›´æ¥æ„å»ºï¼ˆæ¨èï¼‰

#### 2.1 ä¸Šä¼ é¡¹ç›®ä»£ç 

**ä½¿ç”¨ Git**ï¼š

```bash
# åœ¨æœåŠ¡å™¨ä¸Š
cd /opt
git clone your-repo-url app
cd app
```

**ä½¿ç”¨ SCP**ï¼š

```bash
# åœ¨æœ¬åœ°æ‰§è¡Œ
scp -r . user@your-server-ip:/opt/app/
```

#### 2.2 é…ç½®ç¯å¢ƒå˜é‡

```bash
cd /opt/app
cp backend/.env.example backend/.env
vim backend/.env
```

é…ç½®ç¤ºä¾‹ï¼ˆå‚è€ƒä¸Šé¢çš„ç¯å¢ƒå˜é‡é…ç½®ï¼‰

#### 2.3 æ„å»ºå’Œå¯åŠ¨

```bash
# æ„å»ºé•œåƒï¼ˆå¯èƒ½éœ€è¦ 10-20 åˆ†é’Ÿï¼‰
npm run build
# æˆ–
docker-compose -f docker-compose.prod.yml build

# å¯åŠ¨æœåŠ¡
docker-compose -f docker-compose.prod.yml up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps
```

## ç¬¬ä¸‰æ­¥ï¼šåˆå§‹åŒ–æ•°æ®åº“

```bash
# ç­‰å¾… MySQL å®¹å™¨å®Œå…¨å¯åŠ¨ï¼ˆçº¦ 30 ç§’ï¼‰
docker-compose -f docker-compose.prod.yml ps mysql

# åˆå§‹åŒ–æ•°æ®åº“ï¼ˆé¦–æ¬¡éƒ¨ç½²å¿…é¡»æ‰§è¡Œï¼‰
docker-compose -f docker-compose.prod.yml run --rm backend npm run db:init

# éªŒè¯æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ
docker-compose -f docker-compose.prod.yml exec mysql mysql -uroot -p${DB_PASSWORD} -e "SHOW DATABASES;"
```

## ç¬¬å››æ­¥ï¼šéªŒè¯éƒ¨ç½²

### 4.1 æ£€æŸ¥å®¹å™¨çŠ¶æ€

```bash
# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# åº”è¯¥çœ‹åˆ°æ‰€æœ‰å®¹å™¨éƒ½æ˜¯ "Up" çŠ¶æ€
# yl-mysql-prod    Up
# yl-backend-prod  Up (healthy)
# yl-web-prod      Up
# yl-nginx-prod    Up
```

### 4.2 æ£€æŸ¥æœåŠ¡å¥åº·

```bash
# æ£€æŸ¥åç«¯ API
curl http://localhost/api

# æ£€æŸ¥å‰ç«¯é¡µé¢
curl http://localhost/

# æ£€æŸ¥ Nginx
curl -I http://localhost
```

### 4.3 æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f

# æŸ¥çœ‹å•ä¸ªæœåŠ¡æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f backend
docker-compose -f docker-compose.prod.yml logs -f web
docker-compose -f docker-compose.prod.yml logs -f mysql
docker-compose -f docker-compose.prod.yml logs -f nginx
```

### 4.4 è®¿é—®åº”ç”¨

åœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼š
- **å‰ç«¯åº”ç”¨**: `http://your-server-ip` æˆ– `http://your-domain.com`
- **åç«¯ API**: `http://your-server-ip/api` æˆ– `http://your-domain.com/api`
- **Swagger æ–‡æ¡£**: `http://your-server-ip/api`ï¼ˆå¦‚æœå·²å¯ç”¨ï¼‰

## éƒ¨ç½²æ£€æŸ¥æ¸…å•

éƒ¨ç½²å‰è¯·ç¡®è®¤ï¼š

- [ ] å·²ä¿®æ”¹ç”Ÿäº§ç¯å¢ƒå¯†ç ï¼ˆ`DB_PASSWORD`ã€`JWT_SECRET`ï¼‰
- [ ] å·²é…ç½®æ­£ç¡®çš„ `CORS_ORIGIN`
- [ ] æœåŠ¡å™¨å·²å®‰è£… Docker å’Œ Docker Compose
- [ ] æœåŠ¡å™¨é˜²ç«å¢™å·²å¼€æ”¾ 80ã€443 ç«¯å£
- [ ] é•œåƒæ„å»ºæˆåŠŸå¹¶å·²éªŒè¯
- [ ] ç¯å¢ƒå˜é‡æ–‡ä»¶å·²æ­£ç¡®é…ç½®
- [ ] æ•°æ®åº“å·²åˆå§‹åŒ–
- [ ] æ‰€æœ‰å®¹å™¨çŠ¶æ€æ­£å¸¸
- [ ] æœåŠ¡å¯ä»¥æ­£å¸¸è®¿é—®
- [ ] å·²é…ç½®æ•°æ®å¤‡ä»½ç­–ç•¥

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ„å»ºæŒ‡å—](./æ„å»ºæŒ‡å—.md) - ç”Ÿäº§é•œåƒæ„å»º
- [é•œåƒå¯¼å‡º](./é•œåƒå¯¼å‡º.md) - é•œåƒå¯¼å‡ºæ–¹æ³•
- [ç”Ÿäº§ç¯å¢ƒé…ç½®](./ç”Ÿäº§ç¯å¢ƒé…ç½®.md) - ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–
- [æ•…éšœæ’æŸ¥](./æ•…éšœæ’æŸ¥.md) - å¸¸è§é—®é¢˜è§£å†³

