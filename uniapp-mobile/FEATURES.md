# 小程序功能文档

## 📱 项目概述

恋爱打卡小程序是一个记录情侣约会地点的应用，支持在地图上打卡、上传图片和文字描述，记录美好的恋爱时光。

## ✨ 核心功能

### 1. 用户系统

#### 1.1 微信登录/注册
- **功能描述**：用户通过微信小程序登录，首次登录自动注册
- **实现方式**：调用微信 `uni.login()` 获取 code，发送到后端进行登录
- **接口**：`POST /miniapp/user/wxLogin`
- **返回数据**：用户ID、token、用户信息（昵称、头像等）

#### 1.2 用户绑定
- **功能描述**：用户可以绑定另一半，建立恋爱关系
- **绑定方式**：输入另一半的用户ID进行绑定
- **接口**：
  - `POST /miniapp/couple/bind` - 绑定另一半
  - `DELETE /miniapp/couple/unbind` - 解除绑定
  - `GET /miniapp/couple/info` - 获取绑定信息
  - `GET /miniapp/couple/partner` - 获取另一半信息

### 2. 打卡功能

#### 2.1 发布打卡
- **功能描述**：在地图上选择位置，上传图片和文字描述，记录约会地点
- **功能特点**：
  - 📍 支持自动定位当前位置
  - 📍 支持手动选择位置
  - 📍 支持在地图上选择位置
  - 📸 支持上传最多9张图片
  - ✍️ 支持文字描述（最多500字）
  - 🔒 支持设置是否公开（公开后其他用户可在公开地图上看到）
- **页面路径**：`/pages/checkin/add`
- **接口**：`POST /miniapp/checkin`
- **通知机制**：如果用户绑定了另一半，发布打卡时会自动通知另一半

#### 2.2 打卡列表
- **功能描述**：按日期分组展示所有打卡记录
- **功能特点**：
  - 📅 按日期分组显示
  - 🕐 显示打卡时间
  - 📍 显示打卡地点
  - 🖼️ 显示打卡图片（最多3张预览）
- **页面路径**：`/pages/checkin/list`
- **接口**：`GET /miniapp/checkin`

#### 2.3 打卡详情
- **功能描述**：查看单条打卡记录的详细信息
- **功能特点**：
  - 🖼️ 图片轮播展示
  - 📍 显示详细位置信息和坐标
  - ✍️ 显示完整文字描述
  - 🕐 显示打卡时间
  - 🗑️ 支持删除打卡（仅限自己的打卡）
- **页面路径**：`/pages/checkin/detail`
- **接口**：
  - `GET /miniapp/checkin/:id` - 获取详情
  - `DELETE /miniapp/checkin/:id` - 删除打卡

#### 2.4 打卡统计
- **功能描述**：显示打卡统计数据
- **统计维度**：
  - 📊 总打卡数
  - 📅 本月打卡数
  - 📆 本周打卡数
- **接口**：`GET /miniapp/checkin/statistics`

### 3. 地图功能

#### 3.1 首页地图
- **功能描述**：在首页中间部分显示打卡地图
- **功能特点**：
  - 🗺️ 显示用户和另一半的所有打卡点
  - 🌍 支持切换显示/隐藏所有人公开的打卡点
  - 📍 点击标记点可查看打卡详情
  - 🎯 自动定位到第一个打卡点
- **页面位置**：首页中间部分
- **接口**：`GET /miniapp/checkin/map/markers`
  - 支持位置范围查询：`?latitude=39.908823&longitude=116.397470&radius=10&includePublic=true`
  - 如果用户已登录，会自动包含用户自己和绑定用户的私密点位数据

#### 3.2 地图页面
- **功能描述**：全屏地图展示所有打卡点
- **功能特点**：
  - 🗺️ 全屏地图展示
  - 📍 显示所有打卡标记点
  - ➕ 快速发布打卡按钮
  - 📍 定位到当前位置按钮
  - 📍 点击标记点查看详情
- **页面路径**：`/pages/map/map`
- **Tab页面**：是

### 4. 首页功能

#### 4.1 统计卡片
- **显示内容**：
  - 总打卡数
  - 本月打卡数
  - 本周打卡数

#### 4.2 打卡地图
- **位置**：首页中间部分
- **功能**：显示打卡地图，支持切换显示公开打卡

#### 4.3 快捷操作
- **发布打卡**：跳转到发布打卡页面
- **查看地图**：跳转到地图页面
- **打卡记录**：跳转到打卡列表页面

#### 4.4 最新打卡
- **显示内容**：显示最新的一条打卡记录
- **点击操作**：点击可查看详情

## 🔐 权限说明

### 打卡记录权限
- **自己的打卡**：可以查看、编辑、删除
- **另一半的打卡**：可以查看（如果绑定了另一半）
- **公开的打卡**：所有用户都可以查看
- **非公开的打卡**：仅自己和另一半可以查看

### 地图显示规则
- **默认模式**：只显示用户和另一半的打卡
- **公开模式**：显示用户、另一半和所有公开的打卡

## 📊 数据流程

### 发布打卡流程
1. 用户选择位置（自动定位/手动选择/地图选择）
2. 用户输入文字描述（可选）
3. 用户上传图片（可选，最多9张）
4. 用户选择是否公开
5. 提交打卡
6. 后端创建打卡记录
7. 如果用户绑定了另一半，创建通知记录
8. 返回成功，刷新列表

### 查看地图流程
1. 页面加载时获取地图标记点
2. 根据 `includePublic` 参数决定是否包含公开打卡
3. 在地图上显示所有标记点
4. 点击标记点查看详情

## 🎨 UI/UX 特点

- **配色方案**：粉色渐变主题（#ff6b9d 到 #ff8fab）
- **卡片式设计**：使用圆角卡片展示内容
- **响应式布局**：适配不同屏幕尺寸
- **交互反馈**：操作有明确的加载和成功提示
- **空状态处理**：友好的空状态提示

## 📱 页面结构

```
首页 (index)
├── 头部背景
├── 统计卡片（总打卡数、本月打卡、本周打卡）
├── 打卡地图（中间部分）
│   ├── 地图标题和公开打卡开关
│   └── 地图组件（显示打卡标记点）
├── 快捷操作（发布打卡、查看地图、打卡记录）
└── 最新打卡卡片

发布打卡页面 (checkin/add)
├── 位置选择
│   ├── 当前位置显示
│   ├── 重新定位按钮
│   └── 在地图上选择按钮
├── 打卡内容（文本输入）
├── 隐私设置（是否公开开关）
├── 图片上传（最多9张）
└── 发布按钮

打卡列表页面 (checkin/list)
├── 按日期分组的打卡记录
│   ├── 日期标题
│   └── 打卡记录项
│       ├── 时间轴
│       ├── 时间
│       ├── 位置
│       ├── 文字内容
│       └── 图片预览

打卡详情页面 (checkin/detail)
├── 图片轮播（如果有图片）
├── 位置信息
│   ├── 地址
│   └── 坐标
├── 打卡内容
├── 时间信息
└── 删除按钮

地图页面 (map/map)
├── 全屏地图
├── 打卡标记点
├── 发布打卡按钮（右下角）
└── 定位按钮（右下角）
```

## 🔔 通知功能

### 通知触发条件
- 当用户发布打卡时，如果已绑定另一半，会自动创建通知

### 通知类型
- **类型1**：另一半打卡通知

### 通知状态
- **未读**：`isRead = 0`
- **已读**：`isRead = 1`

## 📝 使用说明

### 首次使用
1. 打开小程序，自动调用微信登录
2. 登录成功后进入首页
3. 可以开始发布打卡

### 绑定另一半
1. 进入"我的"页面（如果有）
2. 点击"绑定另一半"
3. 输入另一半的用户ID
4. 确认绑定

### 发布打卡
1. 点击首页"发布打卡"按钮
2. 选择位置（自动定位或手动选择）
3. 输入文字描述（可选）
4. 上传图片（可选）
5. 选择是否公开
6. 点击"发布打卡"

### 查看地图
1. 首页中间的地图默认显示用户和另一半的打卡
2. 点击"显示公开打卡"开关可以查看所有人的公开打卡
3. 点击地图上的标记点可以查看打卡详情

### 查看打卡记录
1. 点击首页"打卡记录"按钮
2. 查看按日期分组的打卡列表
3. 点击任意记录查看详情

## 🛠️ 技术栈

- **框架**：uni-app
- **UI框架**：原生组件 + 自定义样式
- **状态管理**：Pinia
- **HTTP请求**：自定义 http 工具
- **地图**：uni-app 原生 map 组件
- **图片上传**：uni.chooseImage / uni.chooseMedia
- **位置服务**：uni.getLocation / uni.chooseLocation

## 📋 API 接口列表

### 用户相关
- `POST /miniapp/user/wxLogin` - 微信登录/注册
- `GET /miniapp/user/:id` - 获取用户信息

### 绑定相关
- `POST /miniapp/couple/bind` - 绑定另一半
- `DELETE /miniapp/couple/unbind` - 解除绑定
- `GET /miniapp/couple/info` - 获取绑定信息
- `GET /miniapp/couple/partner` - 获取另一半信息

### 打卡相关
- `POST /miniapp/checkin` - 创建打卡记录
- `GET /miniapp/checkin` - 分页查询打卡记录
- `GET /miniapp/checkin/statistics` - 获取打卡统计
- `GET /miniapp/checkin/map/markers` - 获取地图标记点（支持位置范围查询）
  - 查询参数：
    - `latitude` (可选): 中心点纬度
    - `longitude` (可选): 中心点经度
    - `radius` (可选): 查询半径（公里），默认10，范围0.1-1000
    - `includePublic` (可选): 是否包含公开打卡，默认true
  - 功能说明：
    - 支持位置范围查询：提供 latitude、longitude、radius 时，只返回指定范围内的点位
    - 数据权限：未登录用户只返回公开数据；已登录用户返回公开数据 + 自己的私密数据 + 绑定用户的私密数据
- `GET /miniapp/checkin/:id` - 获取打卡详情
- `PATCH /miniapp/checkin/:id` - 更新打卡记录
- `DELETE /miniapp/checkin/:id` - 删除打卡记录

## 🔒 安全说明

- 所有接口（除登录外）都需要 JWT token 认证
- Token 有效期30天
- 用户只能操作自己的打卡记录
- 公开打卡所有人可见，非公开打卡仅自己和另一半可见

## 📱 小程序配置要求

### 权限配置
- **位置权限**：需要用户授权位置信息
- **相册权限**：需要用户授权访问相册（上传图片）

### 域名配置
- 需要在微信小程序后台配置 request 合法域名
- 配置后端 API 域名

## 🐛 已知问题

1. 图片上传功能需要先调用上传接口获取图片URL，当前实现中需要先上传图片
2. 地图逆地理编码需要配置地图服务商的API Key
3. 通知功能目前只是创建通知记录，需要前端实现通知展示功能

## 📈 后续优化建议

1. **通知中心**：实现通知列表页面，展示所有通知
2. **消息推送**：集成微信小程序消息推送，实时通知另一半
3. **打卡分享**：支持分享打卡到微信好友/朋友圈
4. **打卡编辑**：支持编辑已发布的打卡
5. **打卡搜索**：支持按地点、时间搜索打卡记录
6. **地图样式**：支持切换地图样式（标准、卫星等）
7. **打卡足迹**：生成打卡足迹路线图
8. **统计图表**：更丰富的统计图表展示

## 📞 技术支持

如有问题，请查看：
- API文档：`backend/docs/miniapp-api.md`
- 数据库文档：`backend/database/miniapp-checkin.sql`
